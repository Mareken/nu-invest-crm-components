<#-- Puxa os componentes da variável components, para depois fazer um loop nelas, puxando os componentes um a um (por isso a ordem importa) -->
<#assign components = parsejson(DynamicVariable.components)>

<#-- Como o campo de DynamicVariable no Responsys só suporta até cerca de 1900 caracteres, temos que dividir em chunks/pedaços de 1900 máx. cada. A partir desta linha, ele puxa cada um desses pedaços como string (texto) e depois junta eles, para então parsear em XML e pegarmos os dados) -->
<#assign acc = "">

<#list 1..10 as idx>
  <#attempt>
    <#assign item = DynamicVariable["var" + idx_index]>
    <#assign acc = acc + item>
  <#recover>
    <#assign acc = acc + "">
  </#attempt>
</#list>

<#-- Aqui é aonde ele pega todo esses pedaços juntos, adiciona a tag <root> que é a tag pai de todos, e parseia pra XML (pro Rsys e os componentes entenderem os dados) -->
<#global final = "<root>" + acc + "</root>">
<#global doc = parsexml(final)>

<#-- Essas macros são formas de incluir os vários componentes que podem aparecer repetidos mais de uma vez no mesmo e-mail --> 
<#macro cta_macro index>
  <#local ctalist = doc.root.body_cta>
  <#local cta = ctalist[index?number]>

  <#include "cms://contentlibrary/components/body-cta.htm">
</#macro>

<#macro cta_macro2 index>
  <#local ctalist = doc.root.body_cta>
  <#local cta = ctalist[index?number]>

  <#include "cms://contentlibrary/components/body-cta-2.htm">
</#macro>

<#macro title_macro index>
  <#local titlelist = doc.root.body_title>
  <#local title = titlelist[index?number]>

  <#include "cms://contentlibrary/components/body-title.htm">
</#macro>

<#macro attention_macro index>
  <#local attentionlist = doc.root.body_attention>
  <#local attention = attentionlist[index?number]>

  <#include "cms://contentlibrary/components/body-attention.htm">
</#macro>

<#macro bloco_marcas_macro index>
  <#local marcaslist = doc.root.body_bloco_marcas>
  <#local marcas = marcaslist[index?number]>

  <#include "cms://contentlibrary/components/body-bloco-marcas.htm">
</#macro>

<#macro stepsmall_macro index>
  <#local stepsmalllist = doc.root.body_step_small>
  <#local stepsmall = stepsmalllist[index?number]>

  <#include "cms://contentlibrary/components/body-step-small.htm">
</#macro>

<#macro cardproduto_macro index>
  <#local cardprodutolist = doc.root.body_card_produto>
  <#local card = cardprodutolist[index?number]>

  <#include "cms://contentlibrary/components/body-card-produto.htm">
</#macro>

<#macro text_macro index>
  <#local textlist = doc.root.body_text>
  <#local text = textlist[index?number]>

  <#include "cms://contentlibrary/components/body-text.htm">
</#macro>

<#-- Aqui listamos os componentes que pegamos lá na primeira linha, um a um, e importamos da pasta de components do Rsys. Se for componente que pode ser repetido, ele chama a respectiva macro (ver acima) e lá ela cuida da importação correta -->
<#list components as component>
  <#if component["id"] == "body-cta">
    <@cta_macro index=component["index"] />
  <#elseif component["id"] == "body-cta-2">
    <@cta_macro2 index=component["index"] />
  <#elseif component["id"] == "body-bloco-marcas">
    <@bloco_marcas_macro index=component["index"] />
  <#elseif component["id"] == "body-title">
    <@title_macro index=component["index"] />
  <#elseif component["id"] == "body-text">
    <@text_macro index=component["index"] />
  <#elseif component["id"] == "body-attention">
    <@attention_macro index=component["index"] />
  <#elseif component["id"] == "body-step-small">
    <@stepsmall_macro index=component["index"] />
  <#elseif component["id"] == "body-card-produto">
    <@cardproduto_macro index=component["index"] />
  <#else>
    <#include "cms://contentlibrary/components/" + component["id"]?string + ".htm">
  </#if>
</#list>
